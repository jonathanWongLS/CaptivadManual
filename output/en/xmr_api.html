<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Xibo Documentation</title>
        <meta name="viewport" content="width=device-width">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

        <!-- favicon -->
        <link href="../img/favicon.ico" rel="shortcut icon"/>

        <!-- Bootstrap -->
        <link href="../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
        
        <!-- Stylesheets -->
        <link href="../manual.css" rel="stylesheet" media="screen">
        
        <!-- META -->
        <meta name="keywords" content="digital signage, signage, narrow-casting, xibo, open source, agpl, documentation" />
        <meta name="description" content="Xibo is an open source digital signage solution. It supports all main media types and can be interfaced to other sources of data using CSV, Databases or RSS." />
    </head>
    <body data-toc="api">
        <!-- Copyright 2006-2013 Daniel Garner. Part of the Xibo Open Source Digital Signage Solution. Released under the AGPLv3 or later. -->
        <nav id="top-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#ss-navbar">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a href="#" class="navbar-brand">Xibo Documentation</a>
                </div>
            
                <div class="collapse navbar-collapse" id="ss-navbar">
                    <ul class="nav navbar-nav">

                    </ul>
                </div>
            </div>
        </nav>

        <div class="ss_body container">
            <div class="row">
                <div class="col-md-3">
                    <ul id="side-nav" class="nav nav-pills nav-stacked">
                        <!-- <li><a href="index.html" data-toc-name="getting_started">Getting Started</a></li> -->
<li><a href="index.html" data-toc-name="tour">Tour</a></li><li><a href="displays.html" data-toc-name="displays">Displays</a></li><li><a href="layouts.html" data-toc-name="layouts">Layouts</a></li><li><a href="media.html" data-toc-name="media">Library</a></li><li><a href="scheduling.html" data-toc-name="scheduling">Scheduling</a></li><li><a href="users.html" data-toc-name="users">Users</a></li><li><a href="advanced.html" data-toc-name="api">Advanced</a></li><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body><ul>
<li><a href="api.html">Overview</a></li>
<li>
<p><a href="cms_api.html">CMS API</a></p>
</li>
<li>
<p><a href="../api/">CMS API Reference</a></p>
</li>
<li><a href="xmds.html">Player API</a></li>
<li><a href="xlf.html">XLF</a></li>
<li class="active"><a href="xmr_api.html">XMR<span class="glyphicon glyphicon-arrow-left you-are-here-arrow"></span></a></li>
</ul></body></html>

                    </ul>
                </div>
                <div class="col-md-9" role="main">
                    <!--toc=api-->
<h1 id="xibo_message_relay">Xibo Message Relay <a href="#xibo_message_relay" class="header-link"></a></h1>
<p>XMR is the push messaging technology used in Xibo. More introductory
information can be found <a href="xmr.html">here</a>.</p>
<p>XMR consists of a private REQ/RESP and a public PUB/SUB message queue using ZeroMQ. This document will
focus on the public side, which represents the messages flowing from XMR to the Player.</p>
<p>The Private side represents messages flowing from the CMS to XMR. A complete message lifecycle is CMS -&gt;
XMR -&gt; Player.</p>
<h2 id="configuration">Configuration <a href="#configuration" class="header-link"></a></h2>
<p>Each Player must identify itself with the CMS by providing an XMR channel and public key to the
<code>RegisterDisplay</code> XMDS call.</p>
<p>The Channel must be a unique key and it is recommended to generate that from the CMS Address, CMS Key
and Hardware Key.</p>
<p>The XMR Public Key should be the public key of a Public/Private key RSA key. The private key
remains secret and should be stored appropriately by the player.</p>
<h2 id="security">Security <a href="#security" class="header-link"></a></h2>
<p>The PUB/SUB ZeroMQ used by XMR is transferred over TCP and is therefore unencrypted. Although the
message content is benign, the Player must be able to ensure the validity of the message source. Therefore
all messages are encrypted using a RSA key pair.</p>
<p>The Player sends the public key to the CMS, and the CMS will encrypt all messages destined for the
players Channel with the public key provided.</p>
<h2 id="player_subscription">Player Subscription <a href="#player_subscription" class="header-link"></a></h2>
<p>Players should connect to the XMR Public Address supplied in the <code>RegisterDisplay</code> return XML using
a ZeroMQ library and the PUB/SUB subscriber socket. Players should subscribe to the channel they
provided to the CMS in <code>RegisterDisplay</code> and optionally a heartbeat channel called &quot;H&quot;.</p>
<p>The heartbeat channel can be used to determine if the connection is still active and should receive
data every 5 minutes.</p>
<h2 id="receiving_messages">Receiving Messages <a href="#receiving_messages" class="header-link"></a></h2>
<p>Messages sent from XMR are multipart messages, consisting of 3 components (in order):</p>
<ul>
<li>Channel</li>
<li>Key</li>
<li>Message</li>
</ul>
<p>The channel can be used to test whether the message is a heartbeat.</p>
<p>The Key and Message form the <code>openssl_seal</code> encryption used and should be decoded using the same
operation and the private key stored securely by the Player.</p>
<p>Once opened the decrypted message has the following format:</p>
<pre><code>{
    "action": "action name",
    "createdDt": "the message created date - including timezone"
    "ttl": "the message ttl, in seconds"
}</code></pre>
<p>The TTL should be tested against the created date of the message to ensure it has arrived in a
timely fashion. Expired messages should be discarded.</p>
<p>Each message can also have action specific properties.</p>
<h2 id="actions">Actions <a href="#actions" class="header-link"></a></h2>
<p>A range of actions are supported by the CMS:</p>
<table>
<thead>
<tr>
<th>Action</th>
<th>Description</th>
<th>Params</th>
</tr>
</thead>
<tbody>
<tr>
<td>changeLayout</td>
<td>Immediately change to the specified Layout</td>
<td>layoutId,duration,downloadRequired,changeMode</td>
</tr>
<tr>
<td>collectNow</td>
<td>Run XMDS routine collection immediately</td>
<td></td>
</tr>
<tr>
<td>commandActionAction</td>
<td>Run a configured Command</td>
<td>commandCode</td>
</tr>
<tr>
<td>overlayLayout</td>
<td>Immediately overlay a Layout</td>
<td>layoutId,duration,downloadRequired</td>
</tr>
<tr>
<td>rekeyAction</td>
<td>Regenerate the Player Public Key and Channel</td>
<td></td>
</tr>
<tr>
<td>revertToSchedule</td>
<td>Revert to the scheduled content, removing any Layouts/Overlays</td>
<td></td>
</tr>
<tr>
<td>screenShot</td>
<td>Take and send a screen shot</td>
<td></td>
</tr>
</tbody>
</table>
<p>The <code>changeMode</code> parameter of the changeLayout action can be either &quot;replace&quot; or &quot;queue&quot;, where the value
effects the currently active changeLayout actions. The <code>duration</code> is always based on the time since
the message was received, even when in &quot;queue&quot; mode.</p>
                </div>
            </div>
        </div> <!-- container-->
        <footer class="ss_footer" role="contentinfo">
            <div class="container">
                <div class="pull-right">
                    <img class="img-responsive logo" src="../img/logo.png" alt="Xibo" />
                </div>

                <p class="ss_back_to_top">Back to Top</p>

                <p>Designed and built by <a href="http://springsignage.com/">Spring Signage</a> for the <a href="http://www.xibo.org.uk" target="_blank">Xibo Project</a>.</p>
                <p>Open Source Code licensed under <a href="" target="_blank">GNU Affero General Public License v3 or later</a>, documentation under <a rel="license" href="http://creativecommons.org/licenses/by-sa/2.0/uk/" target="_blank">Creative Commons Licence</a>.</p>

                <p class="ss_footer_links">Currently v1.8.4</p>

                <p class="ss_languages"><a href="../en/index.html">en</a> | <a href="../fr/index.html">fr</a></p>
            </div>
        </footer>

        <!-- JavaScript -->
        <script src="../vendor/jquery/jquery-1.9.1.js"></script>
        <script src="../vendor/bootstrap/js/bootstrap.min.js"></script>
        <script type="text/javascript">
            $(document).ready(function() {
                $(".ss_body img").addClass("img-thumbnail");
                $(".ss_body table").addClass("table");

                // Set the selected page based on the TOC name
                // Mark the appropriate top nav element as the selected page
                $("#side-nav a").each(function() {
                    if ($(this).data().tocName == $("body").data().toc)
                        $(this).parent().addClass("active");
                });

                $(".ss_back_to_top").click(function() {
                    $('html, body').animate({scrollTop : 0},800);
                });

                if (inIframe()) {
                    console.log("In Frame");
                    $("#top-nav").css("display", "none");
                    $(".ss-sidebar").parent().css("display", "none");
                }
            });

            function inIframe () {
                try {
                    return window.self !== window.top;
                } catch (e) {
                    return true;
                }
            }
        </script>
    </body>
</html>
